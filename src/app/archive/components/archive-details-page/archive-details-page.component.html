<div class="archive-details-page standard-content-container-width">
  <section class="top">
    <app-case-details *ngIf="case" [case]="case">
      <app-breadcrumb class="breadcrumb" [links]="breadcrumbLinks"></app-breadcrumb>
    </app-case-details>
  </section>

  <app-question-carousel [questions]="archiveQuestions">
    <div class="flag question-container-action"><i class="fas fa-flag"></i>Fall melden</div>
  </app-question-carousel>

  <section class="bottom">
    <div class="facts">
      <app-case-facts *ngIf="case" [case]="case"></app-case-facts>
    </div>

    <div class="overview">
      <h2 class="overview__title mono-font">Fallabschlussbericht</h2>
      <app-case-result-card [case]="case"></app-case-result-card>

      <div class="overview__archive-detail" *ngIf="answerPercentages$ | async as answerPercentages">
        <div *ngFor="let response of givenResponsesPercentages$ | async" class="review-response">
          <div class="review-response__count">{{ response.count }}%</div>
          <div class="review-response__answer">
            der Fragen wurden mit <span class="strong">{{ response.answer }}</span> beantwortet.
          </div>
        </div>

        <div *ngFor="let response of notGivenResponsesPercentages$ | async" class="review-response review-response--small">
          <div>
            <span class="strong">Keine</span> Frage wurde mit <span class="strong">{{ response.answer }}</span> beantwortet.
          </div>
        </div>

        <div class="review-response review-response--small" *ngIf="noCriteriaResponsesPercentage$ | async as noCriteriaResponsesPercentage">
          <span *ngIf="!noCriteriaResponsesPercentage.count">Die Kriterien waren auf alle Fragen anwendbar.</span>
          <ng-container *ngIf="noCriteriaResponsesPercentage.count > 0">
            <div class="review-response__count">{{ noCriteriaResponsesPercentage.count }}%</div>
            <div class="review-response__answer">der Fragen hatten Kriterien, die nicht anwendbar waren.</div>
          </ng-container>
        </div>
      </div>
      <div class="date-info" *ngIf="case">
        <div class="date-info__duration">Der Fall war {{ caseDuration$ | async }} Tage aktiv.</div>
        <div class="date-info__closing-date"><i class="far fa-calendar-check"></i>{{ case.close_timestamp | date: 'dd.MM.yyyy' }}</div>
      </div>
      <div class="tags" *ngIf="case?.warning_tags?.length">
        <div class="tags__title">Folgendes trifft auf den Fall zu</div>
        <div class="tags__content">
          <app-tag-icon *ngFor="let tag of case.warning_tags" [tag]="tag" styleClass="empty"></app-tag-icon>
        </div>
      </div>
      <div class="detectives">
        <div class="detectives__title">Ermittelnde Detektive</div>
        <div class="detectives__body">
          <div class="detective" *ngFor="let detective of detectives; let index = index">
            <div class="detective__medal {{ index === 0 ? 'font-supernova' : index === 1 ? 'font-purple' : '' }}">
              <i *ngIf="index < 2" class="fas fa-medal"></i>
            </div>
            <div class="detective__profile">
              <div class="avatar" [ngClass]="detective.color">{{ detective.user === 'Deaktiviert' ? '?' : detective.user[0] }}</div>
              <div class="detective__profile-info">
                <div class="detective__name {{ detective.user === 'Deaktiviert' ? 'font-italic' : 'font-bold' }}">{{ detective.user }}</div>
                <!-- <div class="job">{{detective.job}}</div> -->
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="comments" *ngIf="case">
        <div class="comments__title">Fallbewertungskommentare</div>
        <div class="comments__body" *ngIf="reviewComments$ | async as reviewComments">
          <app-comment-list [comments]="reviewComments"></app-comment-list>
        </div>
      </div>

      <div class="processing">
        <div class="collapsible-toolbar">
          <span class="collapsible-toolbar__title">Fallbearbeitung</span>
          <span class="collapsible-toolbar__toggle" (click)="isProcessingCollapsed = !isProcessingCollapsed">{{
            isProcessingCollapsed ? 'einblenden' : 'ausblenden'
          }}</span>
          <i class="far" [ngClass]="isProcessingCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'"></i>
        </div>
        <div *ngIf="!isProcessingCollapsed" class="processing__body">
          <div *ngFor="let question of showQuestions; let i = index">
            <!-- todo: set [contributors].. but is the data there? -->
            <app-question
              [question]="question"
              [contributors]="[detectives[0]]"
              [percentageVoted]="33"
              [displayOnly]="true"
              [index]="i"
              [questions]="questions"
            ></app-question>

            <!-- <app-question [question]="question" [percentageVoted]="33" [displayOnly]="true" [index]="i" [questions]="questions"></app-question> -->
          </div>
        </div>
      </div>

      <div class="discussion">
        <div class="collapsible-toolbar">
          <span class="collapsible-toolbar__title">Communitydiskussion</span>
          <span class="collapsible-toolbar__toggle" (click)="isDiscussionCollapsed = !isDiscussionCollapsed">{{
            isDiscussionCollapsed ? 'einblenden' : 'ausblenden'
          }}</span>
          <i class="far" [ngClass]="isDiscussionCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'"></i>
        </div>
        <ng-container *ngIf="!isDiscussionCollapsed">
          <div *ngIf="communityComments$ | async as communityComments" class="discussion__body">
            <app-comment-list [comments]="communityComments | slice: 0:communityCommentsCount"></app-comment-list>

            <div *ngIf="communityCommentsCount <= communityComments.length" class="discussion__more">
              <button (click)="communityCommentsCount = communityCommentsCount + 10">Mehr Kommentare laden</button>
            </div>
          </div>
        </ng-container>
        <app-comment-input [user]="user" (commentSubmitted)="onPostComment($event)" [authenticated]="true"></app-comment-input>
      </div>
    </div>
  </section>
</div>
